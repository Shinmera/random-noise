(in-package #:org.shirakumo.random-noise)

(defun fractal/1d (generator position frequency xxhash &key (octaves 1) (lacunarity 2) (persistence 0.5f0))
  (declare (type xxhash xxhash))
  (declare (type single-float frequency))
  (declare (type (unsigned-byte 16) octaves lacunarity))
  (with-sample a (sample 0f0)
    (let ((amplitude-sum 0f0)
          (amplitude 1f0))
      (dotimes (o octaves)
        (with-sample b (funcall generator position frequency (!32 (+ o xxhash)))
          (incf a (* amplitude b))
          (incf adx (* amplitude bdx))
          (incf amplitude-sum amplitude)
          (setf frequency (* frequency lacunarity))
          (setf amplitude (* amplitude persistence))))
      (let ((s (/ amplitude-sum)))
        (sample (* a s)
                (* adx s))))))

(defun fractal/2d (generator position frequency xxhash &key (octaves 1) (lacunarity 2) (persistence 0.5f0))
  (declare (type xxhash xxhash))
  (declare (type single-float frequency))
  (declare (type (unsigned-byte 16) octaves lacunarity))
  (with-sample a (sample 0f0)
    (let ((amplitude-sum 0f0)
          (amplitude 1f0))
      (dotimes (o octaves)
        (with-sample b (funcall generator position frequency (!32 (+ o xxhash)))
          (incf a (* amplitude b))
          (incf adx (* amplitude bdx))
          (incf ady (* amplitude bdy))
          (incf amplitude-sum amplitude)
          (setf frequency (* frequency lacunarity))
          (setf amplitude (* amplitude persistence))))
      (let ((s (/ amplitude-sum)))
        (sample (* a s)
                (* adx s)
                (* ady s))))))

(defun fractal/3d (generator position frequency xxhash &key (octaves 1) (lacunarity 2) (persistence 0.5f0))
  (declare (type xxhash xxhash))
  (declare (type single-float frequency))
  (declare (type (unsigned-byte 16) octaves lacunarity))
  (with-sample a (sample 0f0)
    (let ((amplitude-sum 0f0)
          (amplitude 1f0))
      (dotimes (o octaves)
        (with-sample b (funcall generator position frequency (!32 (+ o xxhash)))
          (incf a (* amplitude b))
          (incf adx (* amplitude bdx))
          (incf ady (* amplitude bdy))
          (incf adz (* amplitude bdz))
          (incf amplitude-sum amplitude)
          (setf frequency (* frequency lacunarity))
          (setf amplitude (* amplitude persistence))))
      (let ((s (/ amplitude-sum)))
        (sample (* a s)
                (* adx s)
                (* ady s)
                (* adz s))))))
